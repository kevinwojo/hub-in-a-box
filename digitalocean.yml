---
 - hosts: digitalocean

   vars:
    region: 'nyc3'
    image: 'centos-6-x64'
    
    droplets:
     - centos-test
    
   tasks:
   
   - include_vars: "deploysecrets.yml"

   - name: ensure ssh key exists
     user: >
       name={{ ansible_user_id }}
       generate_ssh_key=yes
       ssh_key_file=~/data/.ssh/id_rsa

   - name: Ensure key exists at DigitalOcean
     digital_ocean: >
      state=present
      command=ssh
      name=my_ssh_key
      ssh_pub_key={{ lookup('file', '~/data/.ssh/id_rsa.pub') }}
      api_token={{ digitalocean_api_token }}
     register: my_ssh_key

   - name: Ensure droplet exists
     digital_ocean: >
       state=present
       command=droplet
       name={{ item }}
       unique_name=yes
       size_id=512mb
       region_id={{ region }}
       image_id={{ image }}
       ssh_key_ids={{ my_ssh_key.ssh_key.id }}
       api_token={{ digitalocean_api_token }}
     with_items: droplets
     register: droplet_details
 
   - debug: msg="IP is {{ item.droplet.ip_address }}"
     with_items: droplet_details.results

   - name: Create DNS entries
     digital_ocean_domain:
      state: present
      name: "{{ item.droplet.name }}.kwojo314.com"
      ip: "{{ item.droplet.ip_address }}"
      api_token: "{{ digitalocean_api_token }}"
     with_items: droplet_details.results

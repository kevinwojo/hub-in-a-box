---
 - hosts: digitalocean

   vars:
    region: 'nyc3'
    image: 'centos-6-x64'
    #hub_hostname: 'demo.kwojo314.com'
    #hub_hostname: 'demohub.kwojo314.com'
    
   tasks:
   
   - include_vars: "deploysecrets.yml"

   - name: ensure ssh key exists
     local_action:
      module: user
      name: "{{ ansible_user_id }}"
      generate_ssh_key: yes
      ssh_key_file: "~/data/.ssh/id_rsa"

   - name: Ensure key exists at DigitalOcean
     local_action:
      module: digital_ocean
      state: present
      command: ssh
      name: 'my_ssh_key'
      ssh_pub_key: "{{ lookup('file', '~/data/.ssh/id_rsa.pub') }}"
      api_token: "{{ digitalocean_api_token }}"
     register: my_ssh_key

   - name: Ensure droplet exists
     local_action:
      module: digital_ocean
      state: present
      command: droplet
      name: "{{ hub_hostname }}"
      unique_name: yes
      size_id: 1Gb
      region_id: "{{ region }}"
      image_id: "{{ image }}"
      ssh_key_ids: "{{ my_ssh_key.ssh_key.id }}"
      api_token: "{{ digitalocean_api_token }}"
     register: droplet_details
 
   - name: Create DNS entries
     local_action:
      module: digital_ocean_domain
      state: present
      name: "{{ hub_hostname }}"
      ip: "{{ droplet_details.droplet.ip_address }}"
      api_token: "{{ digitalocean_api_token }}"

---
 - hosts: localhost 

   vars:
    region: 'nyc3'
    image: 'centos-6-x64'
    vm_size: '2gb'
    
   tasks:
   
   - include_vars: "deploysecrets.yml"

   - name: Ensure key exists at DigitalOcean
     local_action:
      module: digital_ocean
      state: present
      command: ssh
      name: 'my_ssh_key'
      ssh_pub_key: "{{  deploy_public_key }}"
      api_token: "{{ digitalocean_api_token }}"
     register: my_ssh_key

   - name: Ensure droplet exists
     local_action:
      module: digital_ocean
      state: present
      command: droplet
      name: "{{ hub_hostname }}"
      unique_name: yes
      size_id: "{{vm_size}}"
      region_id: "{{ region }}"
      image_id: "{{ image }}"
      ssh_key_ids: "{{ my_ssh_key.ssh_key.id }}"
      api_token: "{{ digitalocean_api_token }}"
     register: droplet_details
 
   - name: Create DNS entries
     local_action:
      module: digital_ocean_domain
      state: present
      name: "{{ hub_hostname }}"
      ip: "{{ droplet_details.droplet.ip_address }}"
      api_token: "{{ digitalocean_api_token }}"
